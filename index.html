<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>བོད་ཡིག་གི་མཐེབ་གཞོང་སྦྱོང་བརྡར། (Final Perfect)</title>
    <style>
        /* --- 1. ཡིག་གཟུགས་འཇུག་པ། --- */
        @font-face {
            font-family: 'MyCustomTibetan';
            /* ཁྱེད་ཀྱི་ཡིག་གཟུགས་ཡིག་ཆའི་མིང་ (tibetan.ttf) འདིར་འབྲི་དགོས། */
            src: url('tibetan.ttf') format('truetype'); 
            font-weight: normal;
            font-style: normal;
        }

        :root {
            --text-color: #334155;
            --card-bg: rgba(255, 255, 255, 0.95);
            --accent: #0ea5e9;
            --success: #22c55e;
            --error: #ef4444;
            --key-bg: #ffffff;
            --skin-fill: rgba(224, 172, 105, 0.5); 
            --skin-stroke: rgba(160, 100, 60, 0.6);
            --finger-active: rgba(14, 165, 233, 0.9);
        }

        body.dark-mode {
            background: url('night.jpg') no-repeat center center fixed !important;
            background-size: cover !important;
            --text-color: #f8fafc;
            --card-bg: rgba(15, 23, 42, 0.95);
            --key-bg: #1e293b;
            --skin-fill: rgba(100, 60, 50, 0.4);
            --skin-stroke: rgba(130, 90, 80, 0.5);
        }

        body {
            /* ཡིག་གཟུགས་གོ་རིམ། */
            font-family: 'MyCustomTibetan', "Microsoft Himalaya", "Monlam Uni", sans-serif;
            text-rendering: optimizeLegibility;
            
            background: url('day.jpg') no-repeat center center fixed;
            background-size: cover;

            color: var(--text-color);
            margin: 0;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100vh;
            overflow: hidden;
            user-select: none;
        }

        /* --- MENU SCREEN --- */
        #menu-screen {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(255, 255, 255, 0.1); 
            display: flex; flex-direction: column;
            justify-content: center; align-items: center; z-index: 100;
            backdrop-filter: blur(10px);
        }
        
        body.dark-mode #menu-screen { background: rgba(0, 0, 0, 0.3); }

        h1 { margin-bottom: 30px; font-size: 48px; text-shadow: 0 2px 4px rgba(0,0,0,0.1); }

        .level-container { display: flex; gap: 40px; margin-top: 20px; }
        .level-card {
            background: var(--card-bg); padding: 40px; border-radius: 20px;
            width: 280px; text-align: center; cursor: pointer;
            box-shadow: 0 10px 30px rgba(0,0,0,0.15); transition: 0.3s;
            border: 2px solid transparent;
            display: flex; flex-direction: column; justify-content: center;
        }
        .level-card:hover { transform: translateY(-8px); border-color: var(--accent); box-shadow: 0 15px 40px rgba(14, 165, 233, 0.2); }
        .level-card h2 { color: var(--accent); margin: 0 0 10px 0; font-size: 32px; }
        .level-card p { opacity: 0.8; font-size: 18px; line-height: 1.4; margin: 0; }

        /* --- GAME SCREEN --- */
        #game-screen {
            display: none; flex-direction: column; align-items: center;
            width: 100%; height: 100%;
            padding-top: 10px; box-sizing: border-box;
        }

        nav {
            width: 90%; max-width: 1100px; padding: 5px 0; display: flex; justify-content: space-between; z-index: 60;
        }

        /* 3. TARGET BOX */
        .target-box {
            width: 90%; max-width: 1000px; 
            height: 250px; /* རིམ་པ་དང་པོ་དང་གཉིས་པའི་ཚད་གཞི་འདི་ཡིན། */
            background: var(--card-bg);
            border-radius: 20px;
            box-shadow: 0 8px 20px rgba(0,0,0,0.1);
            display: flex; 
            align-items: center; 
            justify-content: center; 
            padding: 25px; 
            overflow-y: auto; 
            margin-bottom: 10px;
            border: 2px solid rgba(0,0,0,0.05);
            z-index: 60; position: relative;
            scroll-behavior: smooth;
            transition: height 0.3s ease; /* ཆེ་ཆུང་འགྱུར་དུས་འཇམ་པོ། */
        }
        
        .target-box::-webkit-scrollbar { width: 10px; }
        .target-box::-webkit-scrollbar-track { background: transparent; }
        .target-box::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 5px; }

        #target-text-container {
            font-size: 42px; /* ཡིག་གཟུགས་རན་པོ། */
            line-height: 1.8; 
            text-align: center; 
            width: 100%;
            white-space: pre-wrap; word-break: keep-all;
        }
        
        /* --- ཡི་གེའི་འགུལ་རིས་བཟོ་བཅོས། --- */
        .char { 
            color: #94a3b8; 
            transition: color 0.2s, transform 0.2s;
            display: inline-block;
        } 
        
        .char.active { color: var(--text-color); } 
        
        /* ད་ལྟ་འབྲི་བཞིན་པའི་ཡི་གེ་ (འགུལ་བ) */
        .char.current-cursor { 
            color: var(--accent); 
            font-weight: bold;
            transform: translateY(-6px) scale(1.1);
            text-shadow: 0 4px 8px rgba(14, 165, 233, 0.3);
        }

        .char.error { 
            color: var(--error); 
            animation: shake 0.3s; 
        }

        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            25% { transform: translateX(-5px); }
            75% { transform: translateX(5px); }
        }

        .instruction { font-size: 20px; color: var(--accent); margin-bottom: 5px; height: 35px; text-align:center; width:100%; font-weight: bold; }

        /* 2. STATS BAR */
        #stats-bar {
            width: 90%; max-width: 1000px;
            background: var(--card-bg);
            padding: 8px 30px; 
            height: 60px; 
            border-radius: 12px;
            display: flex; justify-content: space-between; align-items: center;
            box-shadow: 0 4px 10px rgba(0,0,0,0.05);
            margin-bottom: 10px; z-index: 60;
            box-sizing: border-box;
        }
        .stat-group { display: flex; gap: 20px; align-items: center; font-size: 20px; color: #666; }
        .stat-val { font-weight: bold; color: var(--accent); margin-left: 5px; }
        
        .progress-controls { display: flex; align-items: center; gap: 10px; flex-grow: 1; justify-content: center; margin: 0 20px; }
        input[type=range] { width: 180px; cursor: pointer; }
        input[type=number] { width: 50px; padding: 3px; border-radius: 5px; border: 1px solid #ccc; text-align: center; font-size: 14px; }

        .btn-pause {
            padding: 5px 15px; font-size: 18px; border-radius: 6px; border: 1px solid var(--accent);
            background: transparent; color: var(--accent); cursor: pointer; transition: 0.2s;
        }
        .btn-pause:hover { background: var(--accent); color: white; }

        /* KEYBOARD & HANDS */
        .keyboard-wrapper {
            position: relative; width: 1000px; height: 400px;
            margin-top: auto; margin-bottom: 30px;
        }
        .keyboard {
            background: #cbd5e1; padding: 25px; border-radius: 25px;
            display: flex; flex-direction: column; gap: 10px;
            box-shadow: 0 15px 40px rgba(0,0,0,0.15);
        }
        body.dark-mode .keyboard { background: #0f172a; }

        .row { display: flex; justify-content: center; gap: 10px; }
        .key {
            width: 60px; height: 60px; background: var(--key-bg); border-radius: 12px;
            box-shadow: 0 5px 0 rgba(0,0,0,0.15); display: flex; flex-direction: column;
            align-items: center; justify-content: center; position: relative;
            color: var(--text-color); transition: transform 0.05s;
        }
        .key.active { background: #bae6fd !important; border: 2px solid var(--accent); transform: translateY(3px); box-shadow: 0 2px 0 rgba(0,0,0,0.15); }
        .key.active .tib, .key.active .eng { color: #0f172a !important; opacity: 1; }
        .key.special { width: 100px; font-size: 14px; }
        .key.space { width: 400px; }
        .key .tib { font-size: 24px; font-weight: bold; z-index: 2; line-height: 1; margin-top: 5px; }
        .key .eng { position: absolute; top: 4px; left: 6px; font-size: 12px; opacity: 0.6; font-family: sans-serif; }

        .hands-overlay { position: absolute; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; z-index: 30; }
        svg { width: 100%; height: 100%; overflow: visible; }
        .hand-shape { fill: var(--skin-fill); stroke: var(--skin-stroke); stroke-width: 1; transition: all 0.1s ease; }
        .hand-shape.active { fill: var(--finger-active); stroke: #0ea5e9; opacity: 0.9; transform: scale(0.96); }

        /* COMPLETION MODAL */
        #completion-modal {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.6); backdrop-filter: blur(5px);
            display: none; justify-content: center; align-items: center; z-index: 200;
        }
        .modal-content {
            background: white; padding: 50px; border-radius: 30px; text-align: center;
            max-width: 600px; box-shadow: 0 20px 50px rgba(0,0,0,0.3); animation: popIn 0.5s ease;
        }
        .modal-poem { font-size: 28px; line-height: 1.6; margin-bottom: 30px; color: #333; font-weight: bold; }
        .btn-finish { padding: 15px 40px; font-size: 24px; background: var(--accent); color: white; border: none; border-radius: 50px; cursor: pointer; }
        @keyframes popIn { from { transform: scale(0.8); opacity: 0; } to { transform: scale(1); opacity: 1; } }
        button { padding: 10px 20px; cursor: pointer; border-radius: 8px; border: 1px solid #ccc; background: rgba(255,255,255,0.5); color: var(--text-color); font-size: 18px; }
        
    </style>
</head>
<body>

    <!-- COMPLETION MODAL -->
    <div id="completion-modal">
        <div class="modal-content">
            <div class="modal-poem">
                མཁས་པ་སློབ་པའི་དུས་ན་སྡུག །<br>
                བདེ་བར་སྡོད་ལ་མཁས་མི་སྲིད། །<br>
                བདེ་བ་ཆུང་ལ་ཆགས་པ་དེས། །<br>
                ཆེན་པོའི་བདེ་བ་ཐོབ་མི་སྲིད། །
            </div>
            <button class="btn-finish" onclick="finishLevel()">རྫོགས་སོ།།</button>
        </div>
    </div>

    <!-- MENU SCREEN -->
    <div id="menu-screen">
        <h1>བོད་ཡིག་གི་མཐེབ་གཞོང་སྦྱོང་བརྡར།</h1>
        <div class="level-container">
            <div class="level-card" onclick="initLevel(1)">
                <h2>ལས་དང་པོ་བ།</h2><p>ཡི་གེ་རྐྱང་པ་དང་དབྱངས།མཐེབ་གནས་ངོས་འཛིན།</p>
            </div>
            <div class="level-card" onclick="initLevel(2)">
                <h2>རྨང་གཞིའི་རིམ་པ།</h2><p>མགོ་འདོགས་དང་ཐ་སྙད།</p>
            </div>
            <div class="level-card" onclick="initLevel(3)">
                <h2>བྱང་ཆ་ལྡན་པ།</h2><p>ལེགས་བཤད་དང་ལྷུག་རྩོམ།</p>
            </div>
        </div>
        <br><br>
        <button onclick="toggleTheme()" style="font-size:20px;">☾ མཚན་མོ། / ཉིན་མོ།</button>
    </div>

    <!-- GAME SCREEN -->
    <div id="game-screen">
        <nav>
            <button onclick="showMenu()">← ཕྱིར་ལོག</button>
            <h3 id="level-title" style="font-size:28px; margin:0;">སྦྱོང་བརྡར།</h3>
            <button onclick="toggleTheme()">☾</button>
        </nav>

        <div class="instruction" id="instruction">ཡི་གེ་བཏགས་ནས་འགོ་རྩོམས་དང་།</div>

        <div class="target-box">
            <div id="target-text-container"></div>
        </div>

        <div id="stats-bar">
            <div class="stat-group">
                <span>དུས་ཚོད།:</span><span id="timer" class="stat-val">00:00</span>
                <span style="margin-left:20px;">ཡིག་གྲངས།:</span><span id="key-count" class="stat-val">0</span>
                <span style="margin-left:20px;">འགྲིག་ཚད།:</span><span id="accuracy" class="stat-val">100%</span>
            </div>
            <div class="progress-controls">
                <label>ཤོག་གྲངས།</label>
                <input type="range" id="prog-slider" min="1" max="100" value="1" oninput="updateProgress(this.value)">
                <input type="number" id="prog-number" min="1" max="100" value="1" onchange="updateProgress(this.value)">
                <span id="total-drills" style="color:#666;">/ 100</span>
            </div>
            <div style="display:flex; gap:10px;">
                <button id="btn-restart" class="btn-pause" onclick="restartSession()">བསྐྱར་འགོ།</button>
                <button id="btn-pause" class="btn-pause" onclick="togglePause()">མཚམས་འཇོག</button>
            </div>
        </div>

        <div class="keyboard-wrapper">
            <div class="keyboard" id="keyboard"></div>
            <div class="hands-overlay">
                <svg viewBox="0 0 1000 420">
                    <g id="left-hand" transform="translate(80, 140) scale(1.1)">
                        <path class="hand-shape" d="M20,100 Q10,220 100,220 L180,220 Q240,220 200,100 Z" style="opacity:0.3; stroke:none;" />
                        <path id="l-pinky" class="hand-shape" d="M-20,180 C-30,100 -20,50 10,50 C40,50 30,100 30,180 Z" />
                        <path id="l-ring" class="hand-shape" d="M35,170 C35,80 40,20 65,20 C90,20 85,80 85,170 Z" />
                        <path id="l-middle" class="hand-shape" d="M90,170 C90,70 95,0 120,0 C145,0 140,70 140,170 Z" />
                        <path id="l-index" class="hand-shape" d="M145,170 C145,80 150,20 175,20 C200,20 195,80 195,170 Z" />
                        <path id="l-thumb" class="hand-shape" d="M200,180 C230,180 260,200 280,230 C260,250 200,240 180,200 Z" />
                    </g>
                    <g id="right-hand" transform="translate(600, 140) scale(1.1)">
                        <path class="hand-shape" d="M240,100 Q250,220 160,220 L80,220 Q40,220 60,100 Z" style="opacity:0.3; stroke:none;" />
                        <path id="r-index" class="hand-shape" d="M60,170 C60,80 65,20 90,20 C115,20 110,80 110,170 Z" />
                        <path id="r-middle" class="hand-shape" d="M115,170 C115,70 120,0 145,0 C170,0 165,70 165,170 Z" />
                        <path id="r-ring" class="hand-shape" d="M170,170 C170,80 175,20 200,20 C225,20 220,80 220,170 Z" />
                        <path id="r-pinky" class="hand-shape" d="M225,180 C235,100 245,50 275,50 C305,50 295,100 275,180 Z" />
                        <path id="r-thumb" class="hand-shape" d="M60,180 C30,180 0,200 -20,230 C0,250 60,240 80,200 Z" />
                    </g>
                </svg>
            </div>
        </div>
    </div>
<script>
    // --- 1. KEY MAPPING (ཡིག་འབྲུ་དང་མཐེབ་གནས།) ---
    const mapNormal = {
        '`':'ཨ', '1':'༡', '2':'༢', '3':'༣', '4':'༤', '5':'༥', '6':'༦', '7':'༧', '8':'༨', '9':'༩', '0':'༠', '-':'ཧ', '=':'ཝ',
        'q':'ཅ', 'w':'ཆ', 'e':'ེ', 'r':'ར', 't':'ཏ', 'y':'ཡ', 'u':'ུ', 'i':'ི', 'o':'ོ', 'p':'ཕ', '[':'ཙ', ']':'ཚ', '\\':'ཛ',
        'a':'འ', 's':'ས', 'd':'ད', 'f':'བ', 'g':'ང', 'h':'མ', 'j':'་', 'k':'ག', 'l':'ལ', ';':'ཞ', "'":'།',
        'z':'ཟ', 'x':'ཤ', 'c':'ཀ', 'v':'ཁ', 'b':'པ', 'n':'ན', 'm':'M', ',':'ཐ', '.':'ཇ', '/':'ཉ', 'Space':' '
    };
    
    const mapShift = {
        '`':'༁', '1':'༪', '2':'༫', '3':'༬', '4':'༭', '5':'༮', '6':'༯', '7':'༰', '8':'༱', '9':'༲', '0':'༳', '-':'༼', '=':'༽',
        'Q':'༕', 'W':'༖', 'E':'༗', 'R':'ྼ', 'T':'ཊ', 'Y':'ྻ', 'U':'༘', 'I':'༙', 'O':'༚', 'P':'༛', '[':'༜', ']':'༝', '\\':'༞',
        'A':'ཱ', 'S':'༟', 'D':'ཌ', 'F':'༾', 'G':'༿', 'H':'࿏', 'J':'༂', 'K':'༃', 'L':'༆', ';':'༇', "'":'༸',
        'Z':'༴', 'X':'ཥ', 'C':'ཀྵ', 'V':'྇', 'B':'྆', 'N':'ཎ', 'M':'M', ',':'ཋ', '.':'༺', '/':'༻'
    };

    const mapStack = {
        '`':'ྸ', '1':'༄', '2':'༅', '3':'ཾ', '4':'ྃ', '5':'༷', '6':'༵', '7':'ཿ', '8':'༔', '9':'༈', '0':'༈', '-':'ྷ', '=':'ྺ',
        'Q':'ྕ', 'W':'ྖ', 'E':'ཻ', 'R':'ྲ', 'T':'ྟ', 'Y':'ྱ', 'U':'ྭ', 'I':'ྀ', 'O':'ཽ', 'P':'ྥ', '[':'ྩ', ']':'ྪ', '\\':'ྫ',
        'A':'ྰ', 'S':'ྶ', 'D':'ྡ', 'F':'ྦ', 'G':'ྔ', 'H':'ྨ', 'J':'྄', 'K':'ྒ', 'L':'ླ', ';':'ྮ', "'":'༎',
        'Z':'', 'X':'ྴ', 'C':'ྐ', 'V':'ྑ', 'B':'ྤ', 'N':'ྣ', 'M':'྅', ',':'ྠ', '.':'ྗ', '/':'ྙ'
    };

    // མཐེབ་གནས་ཕྱིར་འཚོལ་བ། (Reverse Map)
    const charToKeys = {};
    function buildReverseMap() {
        for(let k in mapNormal) { if(mapNormal[k]) charToKeys[mapNormal[k]] = [k.toLowerCase()]; }
        for(let k in mapShift) { if(mapShift[k]) charToKeys[mapShift[k]] = ['Shift', k]; }
        for(let k in mapStack) { if(mapStack[k]) charToKeys[mapStack[k]] = ['m', k.toLowerCase()]; }
        charToKeys[' '] = ['Space'];
    }
    buildReverseMap();

    // མཛུབ་མོ་སྟོན་པ། (Finger Map)
    const keyFingerMap = {
        '1':'l-pinky','q':'l-pinky','a':'l-pinky','z':'l-pinky','Shift':'l-pinky','`':'l-pinky',
        '2':'l-ring','w':'l-ring','s':'l-ring','x':'l-ring',
        '3':'l-middle','e':'l-middle','d':'l-middle','c':'l-middle',
        '4':'l-index','r':'l-index','f':'l-index','v':'l-index',
        '5':'l-index','t':'l-index','g':'l-index','b':'l-index',
        'Space':'l-thumb',
        '6':'r-index','y':'r-index','h':'r-index','n':'r-index',
        '7':'r-index','u':'r-index','j':'r-index','m':'r-index',
        '8':'r-middle','i':'r-middle','k':'r-middle',',':'r-middle',
        '9':'r-ring','o':'r-ring','l':'r-ring','.':'r-ring',
        '0':'r-pinky','p':'r-pinky',';':'r-pinky','/':'r-pinky','\'':'r-pinky','[':'r-pinky',']':'r-pinky','-':'r-pinky','=':'r-pinky','\\':'r-pinky'
    };

    // --- 2. DATA SOURCE (ཚིག་གི་རྒྱུ་ཆ།) ---
    // རིམ་པ་བར་མའི་ཐ་སྙད། (Intermediate Data)
    const intermediateWordsRaw = `སྐད་ཡིག སྐར་མ། སྐུ་གཟུགས། སྐེད་པ། སྐྱིད་པོ། སྐྱུར་མོ། སྐྱོབ་པ། སྐྱེས་པ། སྐོམ་པ། སྐྲ་ལོ། སྒོ་ང་། སྒྲ་དབྱངས། སྒྲུང་གཏམ། སྒམ་ཆུང་། སྒོག་པ། སྒྱུ་རྩལ། སྒེའུ་ཁུང་། སྒྲིག་ལམ། སྒུག་པ། སྒྲོལ་མ། སྔ་དྲོ། སྔོན་པོ། སྔོ་ཚལ། སྔས་མགོ སྔགས་པ། སྙིང་རྗེ། སྙན་ངག སྙི་མོ། སྙུང་ནད། སྙོམས་པོ། སྟག་མོ། སྟོན་ཀ སྟོད་ཐུང་། སྟོབས་ཤུགས། སྟ་རེ། སྟབས་བདེ། སྡེ་བ། སྡོད་ཁང་། སྡོང་པོ། སྡིག་པ། སྣ་ཁུག སྣོད་བཅུད། སྣུམ་ཚིལ། སྣག་ཚ། སྣང་བ། སྤ་ཕྲུག སྤུན་ཟླ། སྤྲིན་པ། སྤྱང་ཀི སྤྲོ་སྐྱིད། སྦ་ཁུག སྦྲང་རྩི། སྦྲུལ་ནག སྦྱོང་བརྡར། སྦྱིན་པ། སྨན་ཁང་། སྨོན་ལམ། སྨྱུག་གུ སྨིན་པ། སྨྲ་བ། རྐང་པ། རྐུབ་ཀྱག རྐང་རྩེད། རྐོ་མ། རྐུན་མ། རྐོང་པོ། རྐྱལ་བ། རྐང་ཐང་། རྐང་གླིང་། རྐ་ཆུ། རྒན་པ། རྒུན་འབྲུམ། རྒོད་པོ། རྒན་ལགས། རྒུད་པ། རྒས་འཁོགས། རྒ་ཤི། རྒྱུག་པ། རྒྱ་གར། རྒྱ་ནག རྔ་མ། རྔན་པ། རྔོན་པ། རྔོ་བ། རྔམ་བརྗིད། རྔ་མོང་། རྗེ་བོ། རྗེས་མ། རྗོད་པ། རྗེས་སུ། རྙིང་པ། རྙོག་དྲ། རྙེད་པ། རྙི་རྒྱ། རྙིད་པ། རྟ་མཆོག རྟག་ཏུ། རྟེན་འབྲེལ། རྟགས་མ། རྟོག་དཔྱོད། རྡོ་རྗེ། རྡོ་བ། རྡོག་ཐོན། རྡུང་བ། རྡེའུ། རྣ་བ། རྣམ་ཀུན། རྣམ་དཔྱོད། རྣལ་འབྱོར། རྣམ་ཤེས། རྦ་རླབས། རྦད་དེ། རྨ་བྱ། རྨི་ལམ། རྨུགས་པ། རྨོངས་པ། རྨོ་བ། རྨང་གཞི། རྨིག་པ། རྩ་བ། རྩམ་པ། རྩྭ་ཐང་། རྩེད་མོ། རྩིས་པ། རྩིག་པ། རྩོམ་ཡིག རྩི་ཤིང་། རྫ་མ། རྫུན་མ། རྫོགས་པ། ལྐོག་ཏུ། ལྐུགས་པ། ལྒང་བུ། ལྔ་པ། ལྔ་ལམ། ལྕགས་རྟ། ལྕེ་ཐོག ལྕང་མ། ལྕགས་ལམ། ལྕམ་སྐུ་ཞབས། ལྗང་ཁུ། ལྗིད་པོ། ལྗོན་ཤིང་། ལྗགས་ལན། ལྟད་མོ། ལྟེ་བ། ལྟོ་བ། ལྟོགས་པ། ལྟ་བ། ལྟེབ་ཁུག ལྡེ་མིག ལྡུམ་ར། ལྡབ་ལྡིབ། ལྡོག་ཕྱོགས། ལྤགས་པ། ལྦུ་བ། ལྦ་བ། ལྷ་ས། ལྷ་ཁང་། ལྷམ་གོག ལྷག་པ། ལྷོ་ཕྱོགས། ལྷིང་འཇགས། ལྷད་མེད། ལྷུང་བ། ལྷག་བསམ། ལྷ་མོ། ལྷོད་པོ། ལྷན་རྒྱས། ལྷུན་གྲུབ། ཀྱག་ཀྱག ཀྱོག་ཀྱོག ཀྱི་ལི། ཁྱིམ་ཚང་། ཁྱི། ཁྱོ་ག ཁྱེད་རང་། ཁྱད་པར། ཁྱེའུ། ཁྱབ་པ། གྱོན་གོས། གྱང་། གྱེན་དུ། གྱོད་པ། གྱ་ནོམ་པ། དཔྱིད་ཀ དཔྱ་ཁྲལ། དཔྱོད་པ། ཕྱག་ལས། ཕྱི་རྒྱལ། ཕྱུགས་རིགས། ཕྱེ་མ། ཕྱོགས་མཚམས། ཕྱག་མཛོད། ཕྱིར་ལོག ཕྱག་བྲིས། ཕྱིང་བ། ཕྱག་འཚལ། བྱ་དེ། བྱང་ཕྱོགས། བྱམས་པ། བྱེ་ཐང་། བྱིས་པ། བྱུག་པ། བྱུ་རུ། བྱེས་འབྱོར། བྱོལ་སོང་། བྱ་དགའ། མྱ་ངན། མྱུར་དུ། མྱོང་བ། མྱུ་གུ། མྱོས་པ། མྱང་བ། དམྱལ་བ། ཀྲུང་གོ ཀྲད་ཀོར། ཀྲོང་ངེར། ཁྲ་ཁྲ། ཁྲིམས་ཁང་། ཁྲོམ་ར། ཁྲུས་ཁང་། ཁྲག་རྩ། ཁྲིད་པ། ཁྲོན་པ། གྲོང་ཁྱེར། གྲོགས་པོ། གྲོད་ཁོག གྲི་ཆུང་། གྲུང་པོ། གྲིབ་ནག གྲོས་མཐུན། གྲུ་གཟིངས། གྲོ་ཞིབ། གྲངས་ཀ དྲིལ་བུ། དྲུག་པ། དྲང་མོ། དྲིན་ཆེན། དྲག་ཆར། དྲི་མ། དྲེལ་པ། དྲོད་ཁོལ། དྲག་ཞན། དྲ་རྒྱ། ཕྲ་མོ། ཕྲག་པ། ཕྲེང་བ། ཕྲུག་གུ། ཕྲད་པ། ཕྲོག་པ། ཕྲ་རྒྱན། བྲིས་པ། བྲང་ཁོག བྲག་རི། བྲོ་བ། བྲན་གཡོག བྲེལ་བ། སྲ་མོ། སྲུང་སྐྱོབ། སྲིན་པོ། སྲོག་ཆགས། སྲིད་ཇུས། སྲན་མ། སྲིང་མོ། སྲོལ་རྒྱུན། སྲང་ལམ། སྲབ་མོ། ཧྲལ་ཧྲུལ། ཧྲག་པོ། ཀླད་པ། ཀློག་དེབ། ཀླུ་མོ། ཀླ་ཀློ། ཀླུང་རྟ། ཀླན་ཀ གླ་བ། གླིང་ག གླུ་དབྱངས། གློག་ཀླད། གླེགས་བམ། གློ་བ། གླེན་པ། གླང་ཆེན། བླ་མ། བློ་རིག བླུན་པོ། བློན་པོ། བློ་གསལ། བླུག་པ། ཟླ་བ། ཟློ་བ། ཟློག་པ། ཟླུམ་པོ། ཟླ་བོ། ཟློས་གར། རླུང་འཕྲིན། རླངས་འཁོར། རླབས་ཆེན། རླབས་ཆེན། རླིག་པ། སློབ་གྲྭ། སློབ་སྦྱོང་། སླ་མོ། སླེབས་པ། སླ་ང་། སློང་མོ་བ། སློབ་མ། སློབ་ཁྲིད། སྒྲ་སྙན། སྒྲོག་ཙེ། སྒྲུབ་པ། སྒྲོན་མེ། སྒྲོམ་གཞི། སྒྲེང་བ། སྒྲིམ་པ། སྤྱན་རས། སྤྱོད་པ། སྤྱིལ་བུ། སྤྱི་ཚོགས། སྤྱན་ཆབ། སྤྱང་པོ། སྤྱུགས་པ། སྦྲ་གུར། སྦྲགས་མ། སྦྲེལ་བ། སྦྲུམས་མ། སྦྲིད་སྨན། སྦྲོན་པ། སྐྱ་རེངས། སྐྱུག་པ། སྐྱོན་བརྗོད། སྐྱེལ་འདྲེན། སྐྱབས་མགོན། སྐྱེད་ཚལ། སྐྲག་སྣང་། སྐྲང་བ། སྐྲུན་པ། སྐྲོག་པ། བསྐྱར་སྦྱོང་། བསྐྱལ་བ། བསྐྱེད་པ། བསྐུར་བ། བསྐལ་བ། བསྐུལ་མ། བསྒྲུབས་པ། བསྒྲགས་པ། བསྒྱུར་བཅོས། བསྒུགས་པ། བསྟན་བཅོས། བསྟོད་པ། བསྟི་གནས། བསྟུན་པ། བརྐྱངས་པ། བརྐུས་པ། བརྒལ་བ། བརྒྱད་པ། བརྒྱུད་པ། བརྒྱན་པ། བརྔས་པ། བརྗེད་པ། བརྗོད་བྱ། བརྙན་འཕྲིན། བརྟག་དཔྱད། བརྟན་པོ། བལྟས་པ། བལྟམས་པ། བསྡད་པ། བསྡུས་པ། འཁྱགས་པ། འཁྱམ་པ། འཁྱུག་པ། འཁྲབ་སྟོན། འཁྲུངས་སྐར། འཁྲུག་པ། འགྲུལ་བ། འགྲེལ་བཤད། འགྲོ་སོང་། འགྲན་བསྡུར། འདྲ་པར། འདྲེ་གདོན། འདྲུད་པ། འཕྲོད་བསྟེན། འཕྲིན་ཡིག འཕྲུལ་ཆས། འབྲི་ཆུ། འབྲོག་པ། འབྲས་བུ། འབྲུག་ཡུལ། དབྱར་ཁ། དབྱིན་ཇི། དབྱེ་བ། དབྱངས་ཅན། དགྲ་བོ། མགྲོན་ཁང་། མགྲིན་པ། འགྲམ་པ། བཀྲ་ཤིས། བཀྲེས་ལྟོགས། བཀྲམ་པ། འབྱོར་བ། འབྱུང་ཁུངས། འབྱུང་བ། མཁྲིས་པ། མཁྲེགས་པོ། ཀྱལ་ཀ ཁྱེའུ་ཁ། གྱ་གྱུ། གྲི་གུ། གླལ་བ། རྒྱལ་ཁབ། རྒྱལ་པོ། རྒྱལ་མོ། རྒྱལ་ས། རྒྱན་ཆ། རྒྱ་མཚོ། རྒྱུན་དུ། རྒྱང་རིང་། སྒུལ་བསྐྱོད། སྒྲོག་གདུང་། བརྒྱ་ཆ། ལྕགས་རི། ལྕུག་ཕྲན། མཆོད་རྟེན། མཇལ་ཁ། རྙོག་པ། སྙིགས་མ། སྙན་ཞུ། སྙན་གྲགས། སྟེང་དུ། སྟོང་པ། བརྟེན་པ། ཐྲིག་ཐྲིག འཐུང་ཆུ། དྲག་པོ། དྲན་པ། འདྲེས་མ། རྡོ་སོལ། རྡོ་བཟོ། སྡེར་མ། སྡོམ་པ། བསྡོམས་རྩིས། རྣོ་ངར། རྣག་ཐོག སྣ་ཐུང་། སྣབས་ལུད། སྣེ་ཁྲིད། སྣེ་མང་། སྤ་གོང། སྤར་མོ། སྤོ་བོ། སྤེལ་བ། སྤུས་ཀ སྤུངས་པ། སྤྱོད་ལམ། སྤྲེལ་ལད། ཕྲ་ཞིང་། ཕྲ་རབ། ཕྲུ་གུ། འཕྲོག་བཅོམ། འཕྲལ་དུ། བྱ་སྤྱོད། བྱང་ཐང་། བྱེ་མ། བྱུར་པོ། བྲག་ཕུག བྲག་ཅ། བྲང་ཁ། བློ་མཐུན། བློ་འདྲི། དབྱུག་པ། འབྲོག་དམངས། འབྲོག་ར། སྦྱང་བྱ། སྦྱོང་བ། མྱུར་ཚད། མྱུལ་མ། དམྱལ་ཁམས། རྩ་ཁྲིམས། རྩ་དོན་། རྩ་མེད། རྩེ་མོ། རྩེར་སོན། རྩིབས་མ། བརྩི་བཀུར། བརྩོན་འགྲུས། ཚ་གྲང་། མཚོ་འགྲམ། རྫ་རི། རྫོགས་ཆེན། རྫོང་དཔོན། ཞབས་བྲོ། གཞུང་ལམ། བཞོན་རྟ། ཟླ་ཕོག ཟླ་མཇུག འོག་བླུགས། ཡར་རྒྱས། གཡང་གཟར། གཡུ་རྩྭ། གཡུལ་ས། གཡེང་བ། རླུང་དམར། རླུང་བུ། ལ་རྒྱ། ཤོག་བུ། གཤོག་པ། སྲ་བརྟན། སྲིད་གཞུང་། སྲུང་དམག སྲོག་སྐྱོབ། སླ་བཅོས། སློབ་གསོ། གསུང་རབ། གསེར་སྐུ། བསམ་བློ། བསོད་ནམས། ལྷ་བཟོ། ལྷག་ལུས། ལྷིང་འཇགས། ལྷུག་པོ། ལྷུན་པོ། ཨ་ཁྲ། ཨ་བྲ། ཨ་མྲ། ཨུ་ཚུགས། ཨར་འདམ། སྐྲ་བཞར། སྒམ་པོ། སྒུལ་ཤུགས། སྒོ་སྲུང་། སྒྲ་སྐད། སྒྱིད་ལུག སྔ་ཕྱི། བསྔོ་བ། སྙིང་ནད། སྟག་ཤར། སྟོད་གོས། སྟོང་ཆ། སྟོན་ཐོག སྣ་ལེན། སྤ་དབྱུག སྤུན་མཆེད། སྤེལ་རེས། སྤོ་བཤུད། སྤྱོད་བཟང་། སྤྲིན་དཀར། སྦག་སྦག སྦྱོང་ཤིང་། སྦྲགས་ཁང་། སྨན་ཆུ། སྨིན་དྲུག རྐང་འཁོར། རྒན་རྒོན། རྒྱ་སྐད། རྒྱ་ལམ། རྒྱན་གོས། རྔ་རྡུང་། རྗེས་དྲན། རྙི་ཐག རྟ་དམག རྟེན་རྫས། ལྟོ་གོས། ལྡེ་མིག ལྤགས་ཤུབས། སྤྲེའུ། སྦུག་དམ། སྦྲ་ནག དྲག་ཆས། དྲེད་མོང་། དྲོ་པོ། འབྲོང་། འབྲུ་རིགས། འབྲོག་ཁུལ། མྱུར་ལམ། རྩྭ་ར། རྩ་གཉིས། རྩེད་ར། རྩིས་དེབ། ཚ་གློག འཚོ་སྐྱོང་། མཛའ་གྲོགས། མཛེས་མ། རྫིང་བུ། ཞབས་ཞུ། ཟླ་ཕྱེད། ཟློས་གར་ཁང་། གཡག་རྒོད། རླངས་ཤུགས། ཤར་ལྷོ། ཤེས་བྱ། ས་བཀྲ། ས་གློག སློབ་དེབ། གསང་གྲོས། ཨ་སྔོན། ཨ་སྒོར། བདག སྟག འབྲུག ཕྱུག བྲག ཁྲག སྨྱུག མཐུན་རྐྱེན། སྲིད་བློན། སྒྲིག་ཆས།`;

    // རིམ་པ་མཐོ་བའི་ལེགས་བཤད་དང་ལྷུག་རྩོམ། (Advanced Data)
    const advancedTextsRaw = [
        `མཁས་པ་ཡོན་ཏན་མཛོད་འཛིན་པ། །དེ་དག་ལེགས་བཤད་རིན་ཆེན་སྡུད། །རྒྱ་མཚོ་ཆེན་པོ་ཆུ་བོའི་གཏེར། །ཡིན་ཕྱིར་ཆུ་བོ་ཐམས་ཅད་འབབ། །`,
        `སྐྱེ་བོ་ཡོན་ཏན་ཡོད་མེད་པ། །བློ་གྲོས་ལྡན་པས་དབྱེ་བར་ཤེས། །རྡུལ་དང་འདྲེས་པའི་ལྕགས་ཕྱེ་རྣམས། །ཁབ་ལེན་རྡོ་ཡིས་ལེན་པར་ཤེས། །`,
        `ལེགས་བཤད་བྱིས་པ་དག་ལས་ཀྱང་། །མཁས་པས་ཡོངས་སུ་བླང་བར་བྱ། །དྲི་ཞིམ་བྱུང་ན་རི་དྭགས་ཀྱི། །ལྟེ་བ་ལས་ཀྱང་གླ་རྩི་ལེན། །`,
        `རིག་པ་ནང་པར་འཆི་ཡང་བསླབ། །ཚེ་འདིར་མཁས་པ་མ་གྱུར་ཀྱང་། །སྐྱེ་བ་ཕྱི་མར་བཅོལ་བ་ཡི། །ནོར་ལ་རང་ཉིད་ལེན་པ་འདྲ། །`,
        `ཡོན་ཏན་ལྡན་ན་སྐྱེ་བོ་ཀུན། །མ་བསྡུས་པར་ཡང་རང་ཉིད་འདུ། །དྲི་ཞིམ་མེ་ཏོག་རྒྱང་རིང་ཡང་། །བུང་བ་སྤྲིན་གྱི་ཚོགས་བཞིན་འཁོར། །`,
        `མཁས་པ་ཤེས་རབ་ཀྱིས་མགུ་ན། །བླུན་པོ་ཤ་འབྲས་ཀྱིས་མགུ་བ། །དེ་ཕྱིར་མཁས་དང་བླུན་པོ་ཡི། །དགའ་ཚུལ་ནད་དང་གསོ་དཔྱད་བཞིན། །`,
        `རྒྱལ་པོ་རང་ཡུལ་ཆེ་བ་ཙམ། །མཁས་པ་ཡུལ་ཁམས་ཀུན་ཏུ་བཀུར། །རྒྱལ་པོས་མཁས་པ་བཀུར་བ་ནི། །རང་ཉིད་མཁས་པར་ཤེས་པའི་རྟགས། །`,
        `མཁས་པ་རང་གི་ཡུལ་བས་ཀྱང་། །གཞན་གྱི་ཡུལ་དུ་མཆོད་པ་ཐོབ། །ཡུལ་དེར་རིན་ཆེན་མ་སྐྱེས་ཤིང་། །ཕྱོགས་གཞན་དག་ནས་ཉོ་བར་བྱེད། །`,
        `རི་བོ་བཞིན་དུ་བརྟན་པ་དང་། །གཞུང་བཟང་མཛངས་ལ་འཛིན་པ་དང་། །མི་ཕྱེད་གྲོགས་དང་བགོ་སྐལ་ལེན། །འདི་བཞི་བདེ་བ་འཐོབ་པའི་གཞི། །`,
        `དམན་པས་སྐྱེ་བོ་མཆོག་བསྟེན་ན། །དེ་ཡི་སྤྱོད་པ་ཤུགས་ལ་འཐོབ། །གླ་རྩིའི་རི་ལ་གནས་པ་ཡི། །ཆུ་ལ་གླ་རྩིའི་དྲི་བཟང་འབྱུང་། །`,
        `འདོད་པ་ཆེ་ལ་མི་མཁས་པ། །དེ་ཡི་སྤྱོད་པ་ཕྱུགས་དང་མཚུངས། །རྩྭ་ཆུ་འབའ་ཞིག་མི་འཚོལ་ཡང་། །སྐེ་ལ་དྲིལ་བུ་འདོགས་སམ་ཅི། །`,
        `ངན་པ་ཕྱུག་ཀྱང་སུ་ཞིག་བཀུར། །ལྟོགས་ཀྱང་འཕགས་པ་སུ་མི་ཕྱག །འཆིང་བུ་མགོ་ལ་བཅིངས་གྱུར་ཀྱང་། །སྨོན་ལམ་བཏབ་ནས་དོར་བར་བྱེད། །`,
        `སྔོན་གྱི་དུས་སུ་ཕྱོགས་འདིར་ཕེབས་པའི་བླ་མ་ལོ་ཙཱ་བ་རྣམས་ཀྱིས་ནི། ལམ་ཐག་རིང་ཞིང་འཇིགས་པ་ཆེ་བས་སྲོག་དང་བསྡོས་ཏེ་བྱོན་དགོས་ལ། དེང་སང་ནི་མེ་འཁོར་ཞེས་བྱ་བ། ལྕགས་ཀྱི་ཁང་པ་འཁོར་ལོ་ཅན་ལ་བཞོན་ནས། ཟླ་བ་དྲུག་གི་ལམ་ལ་ཞག་གསུམ་བཞི་ཡིས་ཆོད་པར་འགྲོ་ཐུབ་པས། ངེད་རང་རྣམས་ལ་ནི་ངལ་བ་དང་འཇིགས་པ་གང་ཡང་མ་བྱུང་།`,
        `རྒྱ་གར་གྱི་ཡུལ་འདི་ནི་ས་གཞི་ཤིན་ཏུ་ཆེ་ཞིང་། མཐའ་མི་མངོན་པའི་བར་དུ་ཡང་། ས་རྡུལ་དང་བྱེ་མ་འབའ་ཞིག་ལས། རྡོ་བ་ཆེ་ཆུང་གཅིག་ཀྱང་རྙེད་པར་དཀའ། ཤིང་སྣ་དང་རྩྭ་ལྡུམ་སྔོ་ལྗང་ངེ་བ་ལོ་ཧྲིལ་པོར་མི་སྐམ་པ་ཡོད་ལ། དགུན་གྱི་དུས་སུའང་བོད་ཀྱི་དབྱར་ཁ་ལས་ཀྱང་དྲོ་བ་ཡོད། སྐབས་འགར་ཆར་པ་ཤིན་ཏུ་ཆེན་པོ་བབས་ནས་ཡུལ་གྲོང་མང་པོ་ཆུས་ཁྱེར་བ་སོགས་ཀྱང་ཡོང་གི་འདུག`,
        `མེ་འཁོར་ཟེར་བ་དེ་ནི་སྦྲུལ་ནག་པོ་ཞིག་ས་ལ་རྒྱུ་བ་དང་འདྲ་བར། མགོ་ནས་དུ་བ་ཕྱུར་ཕྱུར་དུ་གཏོང་ཞིང་། ལུས་པོ་ལྕགས་ཀྱི་ཁང་པ་མང་པོ་སྦྲེལ་བ། ནང་དུ་མི་བརྒྱ་ཕྲག་མང་པོ་ཤོང་བ། རི་བྲག་ཐམས་ཅད་ཕུག་ཅིང་ས་གཞི་གཡོ་བ་ལྟར་འགྲོ་བ། མགྱོགས་ཚད་རླུང་ལྟ་བུ་ཞིག་འདུག`,
        `འཇིག་རྟེན་འདིའི་བྱ་བ་ཐམས་ཅད་ནི་བསྒྲུབས་ནས་འགྲུབ་རྒྱུ་མེད་པ། མཐའ་མེད་པའི་ལས་ཀྱི་འཁོར་ལོ་ཞིག་ཡིན་པར་མཐོང་སྟེ། རང་རེ་རྣམས་ཀྱིས་ཚེ་འདི་ལ་དོན་མེད་ཀྱི་ངལ་བ་ཁོ་ནས་དུས་འདའ་བར་བྱེད་པ་ནི་ཤིན་ཏུ་ཕངས་པའི་གནས་སུ་མཐོང་ངོ་།`
    ];

    // --- 3. GENERATORS (གནད་དོན་བཟོ་མཁན།) ---

    function generateDrillObject(textStr) {
        let keys = [];
        let mapping = []; 
        
        for (let i = 0; i < textStr.length; i++) {
            let char = textStr[i];
            let charKeys = [];
            
            if (charToKeys[char]) {
                charKeys = charToKeys[char];
            } else if (char === ' ') {
                charKeys = ['Space'];
            }
            
            if (charKeys.length > 0) {
                keys.push(...charKeys);
                for(let k=0; k<charKeys.length; k++) {
                    mapping.push(i);
                }
            }
        }
        return { t: textStr, s: keys, m: mapping };
    }

    function generateBeginnerDrills() {
        const rawLines = [
            "ཀ་ཁ་ག་ང་།", "ཅ་ཆ་ཇ་ཉ།", "ཏ་ཐ་ད་ན།", "པ་ཕ་བ་མ།", "ཙ་ཚ་ཛ་ཝ།", "ཞ་ཟ་འ་ཡ།", "ར་ལ་ཤ་ས།", "ཧ་ཨ།",
            "ཨི་ཨུ་ཨེ་ཨོ།",
            "ཀི་ཁི་གི་ངི་།", "ཅི་ཆི་ཇི་ཉི།", "ཏི་ཐི་དི་ནི།", "པི་ཕི་བི་མི།", "ཙི་ཚི་ཛི་ཝི།", "ཞི་ཟི་འི་ཡི།", "རི་ལི་ཤི་སི།", "ཧི་ཨི།",
            "ཀུ་ཁུ་གུ་ངུ།", "ཅུ་ཆུ་ཇུ་ཉུ།", "ཏུ་ཐུ་དུ་ནུ།", "པུ་ཕུ་བུ་མུ།", "ཙུ་ཚུ་ཛུ་ཝུ།", "ཞུ་ཟུ་འུ་ཡུ།", "རུ་ལུ་ཤུ་སུ།", "ཧུ་ཨུ།",
            "ཀེ་ཁེ་གེ་ངེ་།", "ཅེ་ཆེ་ཇེ་ཉེ།", "ཏེ་ཐེ་དེ་ནེ།", "པེ་ཕེ་བེ་མེ།", "ཙེ་ཚེ་ཛེ་ཝེ།", "ཞེ་ཟེ་འེ་ཡེ།", "རེ་ལེ་ཤེ་སེ།", "ཧེ་ཨེ།",
            "ཀོ་ཁོ་གོ་ངོ་།", "ཅོ་ཆོ་ཇོ་ཉོ།", "ཏོ་ཐོ་དོ་ནོ།", "པོ་ཕོ་བོ་མོ།", "ཙོ་ཚོ་ཛོ་ཝོ།", "ཞོ་ཟོ་འོ་ཡོ།", "རོ་ལོ་ཤོ་སོ།", "ཧོ་ཨོ།"
        ];
        return rawLines.map(line => generateDrillObject(line));
    }

    function generateIntermediateDrills() {
        if (!intermediateWordsRaw) return [];
        const words = intermediateWordsRaw.split(/[\s,།]+/).filter(w => w.trim() !== "");
        for (let i = words.length - 1; i > 0; i--) {
            const j = Math.floor(Math.random() * (i + 1));
            [words[i], words[j]] = [words[j], words[i]];
        }
        const drills = [];
        words.forEach(word => {
            let text = word;
            let lastChar = word.slice(-1);
            if (lastChar === 'ང') { text += "་།"; }
            else { text += "།"; }
            drills.push(generateDrillObject(text));
        });
        return drills;
    }

    function generateAdvancedDrills() {
        if (!advancedTextsRaw) return [];
        const drills = [];
        let texts = [...advancedTextsRaw];
        for (let i = texts.length - 1; i > 0; i--) {
            const j = Math.floor(Math.random() * (i + 1));
            [texts[i], texts[j]] = [texts[j], texts[i]];
        }
        texts.forEach(text => {
            const cleanText = text.trim();
            if(cleanText) {
                drills.push(generateDrillObject(cleanText));
            }
        });
        return drills;
    }

    // --- 4. APP LOGIC (ལས་རིམ་གྱི་འགྲོ་སྟངས།) ---
    let currentLevelData = [];
    let currentDrillIdx = 0;
    let currentKeyIdx = 0;
    let activeDrill = null;
    let timerInterval = null;
    let startTime = 0;
    let totalKeysTyped = 0;
    let correctKeysTyped = 0;
    
    let isSessionActive = false; 
    let isPaused = false; 

    const menuScreen = document.getElementById('menu-screen');
    const gameScreen = document.getElementById('game-screen');
    const completionModal = document.getElementById('completion-modal');
    const targetContainer = document.getElementById('target-text-container');
    const instruction = document.getElementById('instruction');
    const keyboardEl = document.getElementById('keyboard');
    const elTimer = document.getElementById('timer');
    const elKeyCount = document.getElementById('key-count');
    const elAcc = document.getElementById('accuracy');
    const elSlider = document.getElementById('prog-slider');
    const elProgNum = document.getElementById('prog-number');
    const elTotalDrills = document.getElementById('total-drills');
    const btnPause = document.getElementById('btn-pause');
    const btnRestart = document.getElementById('btn-restart');

    // ★★★ འདིར་བཟོ་བཅོས་ཆེན་པོ་བྱས་ཡོད། ★★★
    function initLevel(level) {
        if(level === 1) currentLevelData = generateBeginnerDrills();
        else if(level === 2) currentLevelData = generateIntermediateDrills();
        else if(level === 3) currentLevelData = generateAdvancedDrills();
        
        if(!currentLevelData || currentLevelData.length === 0) {
            alert("གནད་དོན་ (Data) མི་འདང་བས་ཁ་ཕྱེ་ཐུབ་མ་སོང་།");
            return;
        }

        menuScreen.style.display = 'none';
        gameScreen.style.display = 'flex';
        
        // --- བྱང་ཆ་ལྡན་པའི་ (L3) དམིགས་བསལ་བཀོད་སྒྲིག ---
        const kbWrapper = document.querySelector('.keyboard-wrapper');
        const targetBox = document.querySelector('.target-box');

        if (level === 3) {
            // བྱང་ཆ་ལྡན་པ།: མཐེབ་གཞོང་སྦས་པ། འཆར་ཁུང་ཆེན་པོ་བཟོ་བ།
            kbWrapper.style.display = 'none';
            targetBox.style.height = '70vh'; // ཧ་ཅང་ཆེན་པོ།
        } else {
            // གཞན་དག་ལ།: མཐེབ་གཞོང་སྟོན་པ། འཆར་ཁུང་སྔར་རྒྱུན་བཞིན།
            kbWrapper.style.display = 'block';
            targetBox.style.height = '250px';
        }

        elSlider.max = currentLevelData.length;
        elProgNum.max = currentLevelData.length;
        elTotalDrills.innerText = "/ " + currentLevelData.length;
        
        restartSession(true);
    }

    function showMenu() {
        stopTimer();
        gameScreen.style.display = 'none';
        menuScreen.style.display = 'flex';
        completionModal.style.display = 'none';
    }

    function finishLevel() {
        showMenu();
    }

    function updateProgress(val) {
        let idx = parseInt(val) - 1;
        if (idx < 0) idx = 0;
        if (idx >= currentLevelData.length) idx = currentLevelData.length - 1;
        currentDrillIdx = idx;
        elSlider.value = idx + 1;
        elProgNum.value = idx + 1;
        currentKeyIdx = 0;
        loadDrill();
    }

    function restartSession(fullReset = false) {
        stopTimer();
        elTimer.innerText = "00:00";
        elKeyCount.innerText = "0";
        elAcc.innerText = "100%";
        totalKeysTyped = 0;
        correctKeysTyped = 0;
        isPaused = false;
        isSessionActive = false;
        btnPause.innerText = "མཚམས་འཇོག";
        
        if (fullReset) {
            updateProgress(1);
        } else {
            currentKeyIdx = 0;
            loadDrill();
        }
    }

    function startTimer() {
        if (isSessionActive) return; 
        isSessionActive = true;
        startTime = Date.now();
        
        timerInterval = setInterval(() => {
            if (!isPaused) {
                const elapsed = Math.floor((Date.now() - startTime) / 1000);
                const m = Math.floor(elapsed/60).toString().padStart(2,'0');
                const s = (elapsed%60).toString().padStart(2,'0');
                elTimer.innerText = `${m}:${s}`;
            } else {
                startTime += 1000;
            }
        }, 1000);
    }

    function stopTimer() {
        clearInterval(timerInterval);
        isSessionActive = false;
    }

    function togglePause() {
        if (!isSessionActive) return;
        isPaused = !isPaused;
        btnPause.innerText = isPaused ? "མུ་མཐུད།" : "མཚམས་འཇོག";
        updateUI();
    }

    function isTibetanCombiner(char) {
        if (!char) return false;
        const code = char.charCodeAt(0);
        return (code >= 0x0F71 && code <= 0x0F84) || 
               (code >= 0x0F90 && code <= 0x0FBC) ||
               (code === 0x0FC6);
    }

    let charIndexToSpanId = []; 

    function loadDrill() {
        if (!currentLevelData || !currentLevelData[currentDrillIdx]) return;
        
        activeDrill = currentLevelData[currentDrillIdx];
        currentKeyIdx = 0;
        targetContainer.innerHTML = '';
        charIndexToSpanId = [];

        const text = activeDrill.t;
        let currentSpanIdx = 0;
        
        for (let i = 0; i < text.length; i++) {
            const char = text[i];
            
            if (i > 0 && isTibetanCombiner(char)) {
                const lastSpan = document.getElementById(`span-${currentSpanIdx - 1}`);
                if (lastSpan) {
                    lastSpan.innerText += char; 
                    charIndexToSpanId[i] = currentSpanIdx - 1; 
                }
            } else {
                const s = document.createElement('span');
                s.innerText = char;
                s.className = 'char';
                s.id = `span-${currentSpanIdx}`;
                targetContainer.appendChild(s);
                
                charIndexToSpanId[i] = currentSpanIdx;
                currentSpanIdx++;
            }
        }
        
        document.querySelector('.target-box').scrollTop = 0;
        updateUI();
    }

    function updateUI() {
        if (!activeDrill) return;
        
        const targetKey = activeDrill.s[currentKeyIdx];
        
        let msg = "འགོ་རྩོམས་དང་།";
        if (isSessionActive) {
            if (isPaused) msg = "མཚམས་འཇོག";
            else if (targetKey === 'Shift') msg = "Shift མནན།";
            else if (targetKey === 'm') msg = "M མནན། (བརྩེགས་མ།)";
            else if (targetKey === 'Space') msg = "བར་སྟོང་མནན།";
            else msg = "མཐེབ་གནས་གནོན།";
        }
        instruction.innerText = msg;

        let currentCharacterIndex = 0;
        if (currentKeyIdx < activeDrill.s.length) {
            currentCharacterIndex = activeDrill.m[currentKeyIdx];
        } else {
            currentCharacterIndex = activeDrill.t.length;
        }

        let activeSpanId = -1;
        if (currentCharacterIndex < activeDrill.t.length) {
            activeSpanId = charIndexToSpanId[currentCharacterIndex];
        }

        let totalSpans = document.getElementById('target-text-container').children.length;

        for(let i=0; i<totalSpans; i++){
            const el = document.getElementById(`span-${i}`);
            if(!el) continue;

            if (i < activeSpanId || (activeSpanId === -1 && currentCharacterIndex >= activeDrill.t.length)) {
                el.className = 'char active';
            } else if (i === activeSpanId) {
                el.className = 'char current-cursor';
                const box = document.querySelector('.target-box');
                const offset = el.offsetTop - box.offsetTop;
                if (offset > 120) { box.scrollTop = offset - 60; }
            } else {
                el.className = 'char';
            }
        }

        renderKeyboard(targetKey);
        highlightFinger(targetKey);
    }

    function highlightFinger(targetKey) {
        document.querySelectorAll('.hand-shape').forEach(f => f.classList.remove('active'));
        if (isPaused) return;
        
        let k = targetKey === 'Shift' ? 'Shift' : targetKey;
        if (!k) return;
        
        const fid = keyFingerMap[k.toLowerCase()] || keyFingerMap[k];
        if(fid) {
            const el = document.getElementById(fid);
            if(el) el.classList.add('active');
        }
    }

    let isShiftHeld = false;
    let isStackActive = false;

    function renderKeyboard(targetKey) {
        const rows = [
            ["`", "1", "2", "3", "4", "5", "6", "7", "8", "9", "0", "-", "=", "Backspace"],
            ["Tab", "Q", "W", "E", "R", "T", "Y", "U", "I", "O", "P", "[", "]", "\\"],
            ["Caps", "A", "S", "D", "F", "G", "H", "J", "K", "L", ";", "'", "Enter"],
            ["Shift", "Z", "X", "C", "V", "B", "N", "M", ",", ".", "/", "Shift"],
            ["Space"]
        ];
        keyboardEl.innerHTML = '';
        
        let tk = "";
        if (!isPaused && targetKey) {
            tk = targetKey === 'Shift' ? 'Shift' : targetKey.toUpperCase();
        }
        
        let currentMap = mapNormal;
        if (isStackActive) currentMap = mapStack;
        else if (isShiftHeld) currentMap = mapShift;

        rows.forEach(row => {
            const rDiv = document.createElement('div');
            rDiv.className = 'row';
            row.forEach(char => {
                const kDiv = document.createElement('div');
                const isSpec = char.length > 1;
                kDiv.className = isSpec ? 'key special' : 'key';
                if(char === 'Space') kDiv.className += ' space';
                
                if (tk && (char.toUpperCase() === tk || (tk==='SHIFT' && char==='Shift'))) {
                    kDiv.classList.add('active');
                }

                if(isSpec) {
                    kDiv.innerText = char;
                } else {
                    const eng = document.createElement('span'); eng.className='eng'; eng.innerText=char;
                    const tib = document.createElement('span'); tib.className='tib';
                    
                    let tc = '';
                    if (currentMap[char]) {
                        tc = currentMap[char];
                    } else if (currentMap[char.toLowerCase()]) {
                        tc = currentMap[char.toLowerCase()];
                    }

                    if(char === 'M') { tib.style.fontSize='14px'; tib.innerText='(བརྩེགས)'; }
                    else { 
                        if(['ི','ུ','ེ','ོ','ཾ','ྃ','༷','༵','ཿ','༔'].includes(tc)) tc = '◌'+tc; 
                        tib.innerText = tc; 
                    }
                    kDiv.appendChild(eng); kDiv.appendChild(tib);
                }
                kDiv.onmousedown = (e) => { e.preventDefault(); if(!isPaused) handleInput(char); };
                rDiv.appendChild(kDiv);
            });
            keyboardEl.appendChild(rDiv);
        });
    }

    function handleInput(key) {
        if(isPaused) return;

        if (!isSessionActive) startTimer();

        if (!activeDrill || !activeDrill.s) return;
        const target = activeDrill.s[currentKeyIdx];
        
        if (key === 'Shift') isShiftHeld = true;
        
        let correct = false;
        if (target === 'Shift' && key === 'Shift') correct = true;
        else if (target && key.toLowerCase() === target.toLowerCase()) correct = true;

        if (correct && key.toLowerCase() === 'm') isStackActive = true;
        else if (correct && key !== 'Shift') isStackActive = false; 

        totalKeysTyped++;
        if(correct) {
            correctKeysTyped++;
            currentKeyIdx++;
            elKeyCount.innerText = correctKeysTyped;
            elAcc.innerText = Math.round((correctKeysTyped/totalKeysTyped)*100) + "%";

            if(currentKeyIdx >= activeDrill.s.length) {
                let nextIdx = currentDrillIdx + 1;
                if(nextIdx >= currentLevelData.length) {
                    stopTimer();
                    completionModal.style.display = 'flex';
                } else {
                    updateProgress(nextIdx + 1);
                }
            } else {
                updateUI();
            }
        } else {
            if (activeDrill) {
                let charIdx = 0;
                if(currentKeyIdx < activeDrill.s.length) charIdx = activeDrill.m[currentKeyIdx];
                else charIdx = activeDrill.t.length -1;

                let spanId = charIndexToSpanId[charIdx];
                const el = document.getElementById(`span-${spanId}`);
                if(el) { el.classList.add('error'); setTimeout(()=>el.classList.remove('error'), 200); }
            }
            elAcc.innerText = Math.round((correctKeysTyped/totalKeysTyped)*100) + "%";
        }
    }

    document.addEventListener('keydown', (e) => {
        if(menuScreen.style.display !== 'none') return;
        
        if(e.key === ' ') e.preventDefault();

        if (e.key === 'Shift') {
            isShiftHeld = true;
            if (activeDrill) renderKeyboard(activeDrill.s[currentKeyIdx]); 
        }

        if(e.key === 'Shift') { handleInput('Shift'); return; }
        if(e.key === ' ') { handleInput('Space'); return; }
        if(e.key.length === 1) handleInput(e.key);
    });

    document.addEventListener('keyup', (e) => {
        if (e.key === 'Shift') {
            isShiftHeld = false;
            if (activeDrill) renderKeyboard(activeDrill.s[currentKeyIdx]);
        }
    });

    function toggleTheme() { document.body.classList.toggle('dark-mode'); }
</script>
</body>
</html>